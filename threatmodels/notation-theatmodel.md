# Notation Threat Model

## Overview

Notation aims for signing and validating software artifacts, ensuring they have not been tampered with and providing security policies to determine which validated artifacts are allowed to be used in your systems.

The following diagram illustrates the architecture and components.

![Notation system overview](../media/notation-system.svg)

- **User**: The User could be a signer or a verifier. A signer interacts with Notation CLI or builds application with Notation library to sign artifacts. A verifier interacts with Notation CLI or builds application with Notation library to verify artifacts against signatures.
- **Artifact Builder**: The actor who produces software artifacts in a build system. The software artifacts to be signed are arbitrary artifacts, which could be container images, helm charts in the context of Cloud, SBOM (Software Bill of Materials) in the context of secure supply chain, and other artifacts. Normally the artifacts are produced by the build process with vulnerabilities scanned, analyzed and fixed. Notation supports signing and verifying artifacts stored in registries or in the file system as OCI image layout.
  - Artifact in registries: Take container images as an example, users can use `docker` commands to produce container images, and store them to a registry. A container image in a registry can be referenced by a fully qualified path, for example `registry.wabbit-networks.io/net-monitor@sha256:xxx`. SBOM is another example, which are generated by tools during build process, stored as OCI artifacts in OCI-compliant registries, and referenced by a fully qualified path as well as container images.
  - Artifact as OCI image layout: OCI image layout is a directory structure that contains files and folders that refer to an OCI image. See [OCI image layout spec](https://github.com/opencontainers/image-spec/blob/v1.0.0/image-layout.md) for details.
- **File System**: The file system where Notation or application built with Notation library is installed. For Notation signing artifacts as OCI image layout, it is the place where artifacts and associated signatures are stored. There are different directories and files as follows:
  - Notation config file, where general configuration is stored
  - Notation trust policy file, where trust policy configuration is stored
  - Notation trust store, where certificate files are stored to validate signatures
  - Notation plugin directory, where Notation plugins are installed
  - Credential store, where the registry or Key management credentials are stored
- **Notation Plugin**: An external component built by different vendors, and integrated to Notation as a signing plugin for signature generation, or as a verifying plugin for signature verification, see [plugin spec](https://github.com/notaryproject/notaryproject/blob/v1.0.0-rc.2/specs/plugin-extensibility.md) for details.
- **Registry**: A registry for Docker and Open Container Initiative (OCI) images, with support for all OCI artifacts. It is the storage where artifacts are pushed to by artifact builder. Registries are outside Notation trust boundary.
- **KMS**: A remote Key Management Service provides key and associated certificate management, and remote signing service. KMSs are outside Notation trust boundary.
- **OCSP Responder**: The [Online Certificate Status Protocol (OCSP)](https://www.rfc-editor.org/rfc/rfc2560) is an Internet protocol used for obtaining the revocation status of an X.509 digital certificate. Notation uses OCSP to validate certificate revocation status from OCSP Responder.

## Notation sign artifacts using remote key

### Data flow

A signer uses Notation to sign artifacts with the private key stored in a KMS, and store signatures in the file system or in a registry.

The following diagram illustrates Notation signing artifacts stored in registries with keys stored in KMS:

![Notation signs artifacts stored in registries](../media/notation-sign-remote.svg)

The following diagram illustrates Notation signing artifacts as OCI image layout with keys stored in KMS:

![Notation signs artifacts as OCI image layout in the filesystem](../media/notation-sign-local.svg)

According to [Notary signature specification](../specs/signature-specification.md), the signing payload is a JSON document which requires the [OCI descriptor](https://github.com/opencontainers/image-spec/blob/v1.0.0/descriptor.md) of the artifact. For artifacts stored in a registry, the descriptor info can be retrieved by inspecting the [image manifest](https://github.com/opencontainers/image-spec/blob/v1.1.0-rc2/manifest.md) of the artifact. For artifacts stored as an [OCI Image layout](https://github.com/opencontainers/image-spec/blob/v1.0.0/image-layout.md), the descriptor info can be retrieved from the `index.json` file from OCI Image layout.

### Threats and Mitigation

|   Title                      | STRIDE threat type     | Threat Status | Priority | Entity          | Description   | Mitigation   |
| ---------------------------- | ---------------------- | ------------- | -------- | --------------- | ------------- | ------------ |
| Compromised signing key      | Information disclosure | Mitigated     | High     | Signer          | Signing keys are compromised, and this may lead to arbitrary artifacts being signed by attackers | Rotate the signing key, and revoke the associated certificates |
| Inaccessible Registry        | Denial of Service      | Mitigated     | High     | Registry        | Registry is not able to service incoming requests or perform up to spec, thus users are unable to publish any artifacts | Users sign artifacts stored in local file system and publish via other medias |
| Serving tampered artifacts   | Tampering              | Mitigated     | High     | Registry        | Data stored in registries are tampered, this may lead to malicious artifacts being signed | Users sign artifacts stored in local file system, and store signatures locally or in the registry |
| Disclosure of signature info | Information disclosure | Mitigated     | High     | Registry        | Attackers eavesdrop on registries, this may lead to the disclosure of sensitive signature info | Users should interact with trusted registries via TLS or Users can sign artifacts stored in local file system and store signature locally |
| Tampered files               | Tampering              | Mitigated     | High     | File System     | Files read by Notation are tampered, this may lead to failure of notation sign operation | Use trusted infrastructure with right file permissions |
| Disclosure of files          | Information disclosure | Mitigated     | High     | File System     | Files are accessed by attackers, this may lead to disclosure of notation config files and credential files | Use trusted infrastructure with right file permissions. Users can use credential store to securely store the credentials. Users can use notation plugin to access signing keys via remote KMS or a HSM device |
| Malicious plugin             | Tampering              | Mitigated     | High     | Notation Plugin | A malicious plugin is installed, this may lead to arbitrary code being executed by attackers | Verify plugin package before installation or plugin is installed by authorized users |

## Notation verify artifacts against signatures

### Data flow

A verifier uses Notation to verify artifacts against signatures stored in the file system or in a registry to ensure the authenticity and integrity of the artifacts before deploying the artifacts.

The following diagram illustrates Notation verifying artifacts stored in a registry:

![Notation verifies artifacts stored in registries](../media/notation-verify-remote.svg)

The following diagram illustrates Notation verifying artifacts stored in a registry with a verification plugin:

![Notation verifies artifacts stored in registries using verification plugin](../media/notation-verify-plugin.svg)

The following diagram illustrates Notation verifying artifacts stored as OCI image layout in the file system:

![Notation verifies artifacts as OCI image layout in the filesystem](../media/notation-verify-local.svg)

The certificates trusted by the verifier are stored in Notation trust store in the file system. Users can download the certificates from KMS or request CA vendor for CA certificates.

### Threats and Mitigation

|   Title                      | STRIDE threat type     | Threat Status | Priority | Entity          | Description   | Mitigation   |
| ---------------------------- | ---------------------- | ------------- | -------- | --------------- | ------------- | ------------ |
| Inaccessible Registry        | Denial of Service      | Mitigated     | High     | Registry        | Registry is not able to service incoming requests or perform up to spec, thus users are unable to verify artifacts | Users verify signatures stored locally |
| Serving tampered artifacts   | Tampering              | Mitigated     | High     | Registry        | Data stored in registries are tampered, this may lead to malicious artifacts being consumed | Users verify artifacts before consuming |
| Disclosure of signature info | Information disclosure | Mitigated     | High     | Registry        | Attackers eavesdrop on registries, this may lead to the disclosure of sensitive signature info | Users should interact with trusted registries via TLS or Users can sign artifacts stored in local file system and store signature locally |
| Tampered files               | Tampering              | Mitigated     | High     | File System      | Files read by Notation are tampered, this may lead to failure of notation verify operation or verification bypassed | Use trusted infrastructure with right file permissions |
| Disclosure of files          | Information disclosure | Mitigated     | High     | File System      | Files are accessed by attackers, this may lead to disclosure of notation config files and credential files | Use trusted infrastructure with right file permissions. Users can use credential store to securely store the credentials |
| Malicious plugin             | Tampering              | Mitigated     | High     | Notation Plugin | A malicious plugin is installed, this may lead to arbitrary code being executed by attackers | Verify plugin package before installation or plugin is installed by authorized users |
| Inaccessible OCSP Responder  | Denial of Service      | Mitigated     | High     | OCSP Responder  | OCSP Responder is not able to service incoming requests or perform up to spec, thus users are unable to validate certificate revocation status | Users can configure trust policy to skip certificate revocation status check |
